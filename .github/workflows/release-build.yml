name: Release builds

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build release binaries (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, windows-latest, macos-latest ]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Build (release)
        run: cargo build --release

      # Adjust BIN_NAME to your binary name
      - name: Package artifact (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          BIN_NAME="minirpg"
          mkdir -p dist
          cp "target/release/$BIN_NAME" "dist/$BIN_NAME"
          tar -czf "dist/${BIN_NAME}-${{ runner.os }}.tar.gz" -C dist "$BIN_NAME"
          rm "dist/$BIN_NAME"

      - name: Package artifact (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $BIN_NAME = "minirpg"
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Copy-Item "target/release/$BIN_NAME.exe" "dist/$BIN_NAME.exe"
          Compress-Archive -Path "dist/$BIN_NAME.exe" -DestinationPath "dist/${BIN_NAME}-${env:RUNNER_OS}.zip"
          Remove-Item "dist/$BIN_NAME.exe"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ runner.os }}
          path: dist/*
